# ğŸš€ Fastify Node.js Boilerplate

ä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„ Fastify åç«¯è„šæ‰‹æ¶ï¼Œé›†æˆäº†å¸¸ç”¨çš„é¡¹ç›®ç‰¹æ€§å’Œæœ€ä½³å®è·µã€‚

## âœ¨ ç‰¹æ€§

- ğŸ› ï¸ **æ¨¡å—åŒ–è®¾è®¡** - é‡‡ç”¨æ¸…æ™°çš„ç›®å½•ç»“æ„å’Œæ¨¡å—åŒ–çš„ä»£ç ç»„ç»‡
- ğŸ”’ **å†…ç½®å®‰å…¨æœºåˆ¶** - JWT è®¤è¯ã€ç»Ÿä¸€çš„é”™è¯¯å¤„ç†
- ğŸ“ **API æ–‡æ¡£** - é›†æˆ Swagger UI è‡ªåŠ¨ç”Ÿæˆ API æ–‡æ¡£
- ğŸ”„ **å¼€å‘ä½“éªŒ** - æ”¯æŒçƒ­é‡è½½ï¼Œå¿«é€Ÿçš„å¼€å‘åé¦ˆ
- ğŸ“Š **æ•°æ®åº“é›†æˆ** - Sequelize ORMï¼Œæ”¯æŒå¤šç§æ•°æ®åº“
- ğŸ’¾ **æœ¬åœ°ç¼“å­˜** - é›†æˆ Node-Cache æå‡æ€§èƒ½
- ğŸ“ **æ—¥å¿—ç³»ç»Ÿ** - åˆ†åˆ«è®°å½•é”™è¯¯å’Œ SQL æ—¥å¿—
- âš™ï¸ **ç¯å¢ƒé…ç½®** - æ”¯æŒå¤šç¯å¢ƒé…ç½®ç®¡ç†

## ğŸ”§ æŠ€æœ¯æ ˆ

- **æ ¸å¿ƒæ¡†æ¶ï¼š** Fastify 4.x
- **æ•°æ®åº“ï¼š** MySQLï¼ˆé€šè¿‡ Sequelize ORMï¼‰
- **è®¤è¯ï¼š** JWT (@fastify/jwt)
- **æ–‡æ¡£ï¼š** Swagger (@fastify/swagger + @fastify/swagger-ui)
- **ç¼“å­˜ï¼š** Node-Cache
- **æ—¥å¿—ï¼š** Winston
- **å¼€å‘å·¥å…·ï¼š** Nodemon
- **ç¯å¢ƒç®¡ç†ï¼š** dotenv

## ğŸ“ ç›®å½•ç»“æ„

```
src/
â”œâ”€â”€ config/           # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ database.js   # æ•°æ®åº“é…ç½®
â”‚   â””â”€â”€ jwt.js        # JWT é…ç½®
â”œâ”€â”€ plugins/          # Fastify æ’ä»¶
â”‚   â”œâ”€â”€ auth.js       # è®¤è¯æ’ä»¶
â”‚   â”œâ”€â”€ swagger.js    # API æ–‡æ¡£æ’ä»¶
â”‚   â””â”€â”€ cache.js      # ç¼“å­˜æ’ä»¶
â”œâ”€â”€ middlewares/      # ä¸­é—´ä»¶
â”‚   â”œâ”€â”€ error-handler.js    # é”™è¯¯å¤„ç†
â”‚   â””â”€â”€ response-formatter.js # å“åº”æ ¼å¼åŒ–
â”œâ”€â”€ models/           # æ•°æ®æ¨¡å‹
â”‚   â””â”€â”€ user.js       # ç”¨æˆ·æ¨¡å‹
â”œâ”€â”€ routes/           # è·¯ç”±æ–‡ä»¶
â”‚   â”œâ”€â”€ index.js      # è·¯ç”±æ³¨å†Œ
â”‚   â””â”€â”€ user.js       # ç”¨æˆ·ç›¸å…³è·¯ç”±
â”œâ”€â”€ utils/            # å·¥å…·å‡½æ•°
â”‚   â””â”€â”€ logger.js     # æ—¥å¿—å·¥å…·
â””â”€â”€ app.js           # åº”ç”¨å…¥å£æ–‡ä»¶
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- Node.js >= 14
- MySQL >= 5.7

### å®‰è£…

```bash
# å…‹éš†é¡¹ç›®
git clone <repository-url>

# å®‰è£…ä¾èµ–
npm install
```

### é…ç½®

1. å¤åˆ¶ç¯å¢ƒå˜é‡æ–‡ä»¶
```bash
cp .env.example .env
```

2. ä¿®æ”¹ `.env` é…ç½®
```env
PORT=3000
NODE_ENV=development
DB_HOST=localhost
DB_PORT=3306
DB_NAME=fastify_db
DB_USER=root
DB_PASS=password
JWT_SECRET=your-secret-key
```

### è¿è¡Œ

```bash
# å¼€å‘ç¯å¢ƒ
npm run dev

# ç”Ÿäº§ç¯å¢ƒ
npm start
```

## ğŸ› ï¸ API æ–‡æ¡£

å¯åŠ¨é¡¹ç›®åè®¿é—®ï¼š`http://localhost:3000/docs`

## ğŸ”’ è®¤è¯

é¡¹ç›®ä½¿ç”¨ JWT è¿›è¡Œè®¤è¯ï¼Œåœ¨éœ€è¦è®¤è¯çš„è·¯ç”±ä¸­ä½¿ç”¨ `authenticate` è£…é¥°å™¨ï¼š

```javascript
fastify.get('/protected', 
  { onRequest: [fastify.authenticate] }, 
  async (request, reply) => {
    return { user: request.user };
  }
);
```

## ğŸ“ æ—¥å¿—

ç³»ç»Ÿä½¿ç”¨ Winston å¤„ç†æ—¥å¿—ï¼Œåˆ†ä¸ºä¸¤ç±»ï¼š

- **é”™è¯¯æ—¥å¿—ï¼š** `logs/error.log`
- **SQL æ—¥å¿—ï¼š** `logs/sql.log`

## ğŸ”„ å“åº”æ ¼å¼

ç»Ÿä¸€çš„å“åº”æ ¼å¼ï¼š

```javascript
// æˆåŠŸå“åº”
{
  "success": true,
  "message": "success",
  "data": {}
}

// é”™è¯¯å“åº”
{
  "success": false,
  "message": "é”™è¯¯ä¿¡æ¯",
  "data": null,
  "code": 500 || 'è‡ªå®šä¹‰é”™è¯¯ç '
}
```

## ğŸ¯ ç¤ºä¾‹æ¥å£

### ç”¨æˆ·ç™»å½•
```http
POST /api/users/login
Content-Type: application/json

{
  "username": "admin",
  "password": "password"
}
```

### è·å–ç”¨æˆ·åˆ—è¡¨
```http
GET /api/users
Authorization: Bearer <token>
```

## ğŸ”§ å¼€å‘æŒ‡å—

### æ·»åŠ æ–°è·¯ç”±

1. åœ¨ `routes` ç›®å½•åˆ›å»ºè·¯ç”±æ–‡ä»¶ï¼ˆä¾‹å¦‚ `product.js`ï¼‰ï¼š

```javascript
// src/routes/product.js
const { Product } = require('../models');

module.exports = async function (fastify, opts) {
  // è·å–äº§å“åˆ—è¡¨
  fastify.get('/', {
    schema: {
      description: 'è·å–äº§å“åˆ—è¡¨',
      tags: ['products'],
      querystring: {
        type: 'object',
        properties: {
          page: { type: 'integer', default: 1 },
          limit: { type: 'integer', default: 10 }
        }
      },
      response: {
        200: {
          type: 'object',
          properties: {
            success: { type: 'boolean' },
            message: { type: 'string' },
            data: {
              type: 'array',
              items: {
                type: 'object',
                properties: {
                  id: { type: 'integer' },
                  name: { type: 'string' },
                  price: { type: 'number' },
                  createdAt: { type: 'string' }
                }
              }
            }
          }
        }
      }
    },
    handler: async (request, reply) => {
      const { page, limit } = request.query;
      const offset = (page - 1) * limit;
      
      const products = await Product.findAndCountAll({
        limit,
        offset,
        order: [['createdAt', 'DESC']]
      });
      
      return products;
    }
  });

  // åˆ›å»ºäº§å“
  fastify.post('/', {
    schema: {
      description: 'åˆ›å»ºæ–°äº§å“',
      tags: ['products'],
      body: {
        type: 'object',
        required: ['name', 'price'],
        properties: {
          name: { type: 'string' },
          price: { type: 'number' },
          description: { type: 'string' }
        }
      }
    },
    // ä½¿ç”¨è®¤è¯ä¸­é—´ä»¶
    onRequest: [fastify.authenticate],
    handler: async (request, reply) => {
      const product = await Product.create(request.body);
      reply.code(201).send(product);
    }
  });

  // è·å–å•ä¸ªäº§å“
  fastify.get('/:id', {
    schema: {
      description: 'è·å–äº§å“è¯¦æƒ…',
      tags: ['products'],
      params: {
        type: 'object',
        properties: {
          id: { type: 'integer' }
        }
      }
    },
    handler: async (request, reply) => {
      const product = await Product.findByPk(request.params.id);
      if (!product) {
        reply.code(404).send({
          success: false,
          message: 'Product not found'
        });
        return;
      }
      return product;
    }
  });
};
```

2. åœ¨ `routes/index.js` æ³¨å†Œè·¯ç”±ï¼š

```javascript
// src/routes/index.js
const userRoutes = require('./user');
const productRoutes = require('./product');

module.exports = async function (fastify, opts) {
  fastify.register(userRoutes, { prefix: '/api/users' });
  fastify.register(productRoutes, { prefix: '/api/products' });
};
```

### æ·»åŠ æ–°æ¨¡å‹

1. åœ¨ `models` ç›®å½•åˆ›å»ºæ¨¡å‹æ–‡ä»¶ï¼ˆä¾‹å¦‚ `product.js`ï¼‰ï¼š

```javascript
// src/models/product.js
const { DataTypes } = require('sequelize');
const sequelize = require('../config/database');

const Product = sequelize.define('Product', {
  id: {
    type: DataTypes.INTEGER,
    primaryKey: true,
    autoIncrement: true
  },
  name: {
    type: DataTypes.STRING,
    allowNull: false,
    validate: {
      notEmpty: true,
      len: [2, 100]
    }
  },
  price: {
    type: DataTypes.DECIMAL(10, 2),
    allowNull: false,
    validate: {
      min: 0
    }
  },
  description: {
    type: DataTypes.TEXT,
    allowNull: true
  },
  status: {
    type: DataTypes.ENUM('active', 'inactive'),
    defaultValue: 'active'
  }
}, {
  // æ¨¡å‹é€‰é¡¹
  timestamps: true,  // æ·»åŠ  createdAt å’Œ updatedAt
  paranoid: true,   // è½¯åˆ é™¤ï¼Œæ·»åŠ  deletedAt
  indexes: [
    {
      unique: true,
      fields: ['name']
    }
  ]
});

// å®šä¹‰æ¨¡å‹å…³è”
Product.associate = (models) => {
  // ä¾‹å¦‚ï¼Œä¸ Category æ¨¡å‹çš„å…³è”
  Product.belongsTo(models.Category, {
    foreignKey: 'categoryId',
    as: 'category'
  });
  
  // ä¸ Order æ¨¡å‹çš„å¤šå¯¹å¤šå…³è”
  Product.belongsToMany(models.Order, {
    through: 'OrderProducts',
    as: 'orders',
    foreignKey: 'productId'
  });
};

// æ¨¡å‹é’©å­
Product.beforeCreate(async (product) => {
  // ä¾‹å¦‚ï¼Œåœ¨åˆ›å»ºå‰å¤„ç†ä¸€äº›æ•°æ®
  product.name = product.name.trim();
});

// æ¨¡å‹æ–¹æ³•
Product.prototype.isAvailable = function() {
  return this.status === 'active';
};

// é™æ€æ–¹æ³•
Product.findAvailable = function() {
  return this.findAll({
    where: {
      status: 'active'
    }
  });
};

module.exports = Product;
```

2. åœ¨ `models/index.js` ä¸­æ³¨å†Œæ¨¡å‹ï¼ˆå¦‚æœè¿˜æ²¡æœ‰è¿™ä¸ªæ–‡ä»¶ï¼Œéœ€è¦åˆ›å»ºï¼‰ï¼š

```javascript
// src/models/index.js
const fs = require('fs');
const path = require('path');
const sequelize = require('../config/database');

const models = {};

// è‡ªåŠ¨åŠ è½½æ‰€æœ‰æ¨¡å‹
fs.readdirSync(__dirname)
  .filter(file => 
    file.indexOf('.') !== 0 && 
    file !== 'index.js' && 
    file.slice(-3) === '.js'
  )
  .forEach(file => {
    const model = require(path.join(__dirname, file));
    models[model.name] = model;
  });

// æ³¨å†Œæ¨¡å‹å…³è”
Object.keys(models).forEach(modelName => {
  if (models[modelName].associate) {
    models[modelName].associate(models);
  }
});

models.sequelize = sequelize;

module.exports = models;
```

3. ä½¿ç”¨ç¤ºä¾‹ï¼š

```javascript
// åœ¨è·¯ç”±æˆ–æœåŠ¡ä¸­ä½¿ç”¨æ¨¡å‹
const { Product } = require('../models');

// åˆ›å»ºäº§å“
const product = await Product.create({
  name: 'iPhone 13',
  price: 999.99,
  description: 'Latest iPhone model'
});

// æŸ¥è¯¢äº§å“
const products = await Product.findAvailable();

// ä½¿ç”¨æ¨¡å‹æ–¹æ³•
const isAvailable = product.isAvailable();
```

## ğŸ“¦ ç”Ÿäº§éƒ¨ç½²

1. è®¾ç½®ç”Ÿäº§ç¯å¢ƒå˜é‡
```bash
NODE_ENV=production
```

2. æ„å»ºå¹¶å¯åŠ¨
```bash
npm run build
npm start
```

## ğŸ¤ è´¡çŒ®æŒ‡å—

1. Fork é¡¹ç›®
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯ï¼š`git checkout -b feature/AmazingFeature`
3. æäº¤æ”¹åŠ¨ï¼š`git commit -m 'Add AmazingFeature'`
4. æ¨é€åˆ†æ”¯ï¼š`git push origin feature/AmazingFeature`
5. æäº¤ Pull Request

## ğŸ“„ è®¸å¯è¯

MIT License - è¯¦è§ [LICENSE](LICENSE) æ–‡ä»¶

## ğŸ†˜ æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æäº¤ Issue è”ç³»æˆ‘ï¼š
